CREATE DATABASE IF NOT EXISTS movie_theater;
USE movie_theater;

DROP TABLE IF EXISTS movie;

CREATE TABLE movie (
  id int NOT NULL AUTO_INCREMENT,
  addedDate datetime(6) DEFAULT NULL,
  title varchar(255) DEFAULT NULL,
  url varchar(255) DEFAULT NULL,
  PRIMARY KEY (id)
);

DROP TABLE IF EXISTS schedule;

CREATE TABLE schedule (
  id int NOT NULL AUTO_INCREMENT,
  movieId int DEFAULT NULL,
  price double NOT NULL,
  screenId int DEFAULT NULL,
  startTime datetime(6) DEFAULT NULL,
  PRIMARY KEY (id)
);

DROP TABLE IF EXISTS screen;

CREATE TABLE screen (
  id int NOT NULL AUTO_INCREMENT,
  capacity int NOT NULL,
  length int NOT NULL,
  screenName varchar(255) DEFAULT NULL,
  width int NOT NULL,
  PRIMARY KEY (`id`)
);

DROP TABLE IF EXISTS screens;

CREATE TABLE screens (
  id int NOT NULL AUTO_INCREMENT,
  screenName varchar(20) NOT NULL,
  length int NOT NULL,
  width int NOT NULL,
  capacity int GENERATED ALWAYS AS ((width * length)) STORED,
  PRIMARY KEY (id),
  UNIQUE KEY screens_pk (screen_name)
);

DROP TABLE IF EXISTS seat;

CREATE TABLE seat (
  schedule_id int NOT NULL,
  seatNumber int NOT NULL,
  isAvaliable int NOT NULL,
  PRIMARY KEY (schedule_id,seat_number)
);

DROP TABLE IF EXISTS users;

CREATE TABLE users (
  id int NOT NULL,
  cardNumber varchar(255) DEFAULT NULL,
  email varchar(255) DEFAULT NULL,
  membershipExpiry_date datetime(6) DEFAULT NULL,
  password varchar(255) DEFAULT NULL,
  paymentMethod varchar(255) DEFAULT NULL,
  PRIMARY KEY (id)
);

DROP PROCEDURE IF EXISTS insert_schedule_seats;

DELIMITER $$
create procedure insert_schedule_seats(IN p_schedule_id int, IN p_screen_id int)
BEGIN
	DECLARE i INT DEFAULT 1;
	DECLARE screen_capacity INT;

    SELECT capacity INTO screen_capacity FROM screens WHERE id = p_screen_id;

    WHILE i <= screen_capacity DO
            INSERT INTO seats (schedule_id, seat_number)
            VALUES (p_schedule_id, i);
            SET i = i + 1;
	END WHILE;
END $$
DELIMITER ;

DROP TRIGGER IF EXISTS after_insert_schedule;

DELIMITER $$
create trigger after_insert_schedule
after insert
on schedule
for each row
BEGIN
    CALL insert_schedule_seats(NEW.id, NEW.screen_id);
END $$
DELIMITER ;
